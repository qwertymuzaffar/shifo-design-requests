<div class="md:p-6 p-3">
  <div class="space-y-2 md:space-y-6">
    <div class="flex items-center justify-between flex-wrap gap-3">
      <div>
        <button
          (click)="goBack()"
          class="flex items-center gap-2 text-gray-600 hover:text-gray-900 transition-colors mb-2"
        >
          <lucide-icon [img]="ArrowLeftIcon" [size]="20"></lucide-icon>
          <span>{{ 'patientRequests.back' | transloco }}</span>
        </button>
        <h1 class="md:text-3xl text-xl font-bold text-gray-900">
          {{ 'patientRequests.title' | transloco }}
        </h1>
        <p class="text-gray-600 mt-1 text-sm md:text-base">
          {{ 'patientRequests.subtitle' | transloco }}
        </p>
      </div>

      <div class="flex gap-2 md:gap-3 flex-wrap">
        <div class="bg-white rounded-lg px-3 md:px-4 py-2 md:py-3 shadow-sm border border-gray-100">
          <div class="text-xl md:text-2xl font-bold text-amber-600">{{ pendingCount }}</div>
          <div class="text-xs text-gray-600">{{ 'patientRequests.status.pending' | transloco }}</div>
        </div>
        <div class="bg-white rounded-lg px-3 md:px-4 py-2 md:py-3 shadow-sm border border-gray-100">
          <div class="text-xl md:text-2xl font-bold text-green-600">{{ approvedCount }}</div>
          <div class="text-xs text-gray-600">{{ 'patientRequests.status.approved' | transloco }}</div>
        </div>
        <div class="bg-white rounded-lg px-3 md:px-4 py-2 md:py-3 shadow-sm border border-gray-100">
          <div class="text-xl md:text-2xl font-bold text-red-600">{{ rejectedCount }}</div>
          <div class="text-xs text-gray-600">{{ 'patientRequests.status.rejected' | transloco }}</div>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 md:p-6">
      <div class="flex flex-col md:flex-row gap-3 md:gap-4">
        <div class="flex-1 relative">
          <lucide-icon
            [img]="SearchIcon"
            [size]="20"
            class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"
          ></lucide-icon>
          <input
            type="text"
            [ngModel]="searchQuery()"
            (ngModelChange)="searchQuery.set($event)"
            [placeholder]="'patientRequests.search_placeholder' | transloco"
            class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500"
          />
        </div>

        <div class="flex gap-2 flex-wrap">
          <button
            (click)="selectedStatus.set('all')"
            [class]="selectedStatus() === 'all' ? 'bg-sky-500 text-white' : 'bg-white text-gray-700 border border-gray-300'"
            class="px-3 md:px-4 py-2 rounded-lg transition-colors text-sm"
          >
            {{ 'patientRequests.filter.all' | transloco }}
          </button>
          <button
            (click)="selectedStatus.set('pending')"
            [class]="selectedStatus() === 'pending' ? 'bg-blue-500 text-white hover:bg-blue-600' : 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-50'"
            class="px-3 md:px-4 py-2 rounded-lg transition-colors text-sm"
          >
            {{ 'patientRequests.filter.pending' | transloco }}
          </button>
          <button
            (click)="selectedStatus.set('approved')"
            [class]="selectedStatus() === 'approved' ? 'bg-green-500 text-white' : 'bg-white text-gray-700 border border-gray-300'"
            class="px-3 md:px-4 py-2 rounded-lg transition-colors text-sm"
          >
            {{ 'patientRequests.filter.approved' | transloco }}
          </button>
          <button
            (click)="selectedStatus.set('rejected')"
            [class]="selectedStatus() === 'rejected' ? 'bg-red-500 text-white' : 'bg-white text-gray-700 border border-gray-300'"
            class="px-3 md:px-4 py-2 rounded-lg transition-colors text-sm"
          >
            {{ 'patientRequests.filter.rejected' | transloco }}
          </button>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-gray-100">
      <div class="md:p-6 p-3">
        @if (filteredRequests.length === 0) {
          <div class="p-12 text-center">
            <div class="text-gray-400 text-5xl mb-4">üìã</div>
            <h3 class="text-xl font-semibold text-gray-700 mb-2">
              {{ 'patientRequests.no_requests' | transloco }}
            </h3>
            <p class="text-gray-500">
              {{ 'patientRequests.no_requests_desc' | transloco }}
            </p>
          </div>
        } @else {
          <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-3 md:gap-4">
            @for (request of filteredRequests; track request.id) {
              <div class="bg-white rounded-xl border border-gray-200 shadow-sm hover:shadow-lg transition-all hover:border-gray-300">
                <div class="p-4 md:p-5">
                  <div class="flex items-start justify-between mb-3">
                    <div class="flex-1 min-w-0">
                      <h3 class="font-semibold text-gray-900 text-base md:text-lg truncate">{{ request.fullName }}</h3>
                      <p class="text-sm text-gray-600 mt-1">{{ request.phone }}</p>
                    </div>
                    <span
                      [class]="getStatusClass(request.status)"
                      class="px-2 md:px-3 py-1 text-xs font-medium rounded-full whitespace-nowrap ml-2"
                    >
                      {{ 'patientRequests.status.' + request.status | transloco }}
                    </span>
                  </div>

                  <div class="space-y-2 mb-4">
                    <div class="flex items-center gap-2 text-sm text-gray-600">
                      <span class="font-medium">{{ 'patientRequests.birth_date' | transloco }}:</span>
                      <span>{{ request.birthDate }}</span>
                    </div>
                    @if (request.address) {
                      <div class="flex items-start gap-2 text-sm text-gray-600">
                        <span class="font-medium whitespace-nowrap">{{ 'patientRequests.address' | transloco }}:</span>
                        <span class="truncate">{{ getAddress(request.address) }}</span>
                      </div>
                    }
                    <div class="flex items-center gap-2 text-sm text-gray-500">
                      <span>‚è∞</span>
                      <span>{{ formatDate(request.createdAt) }}</span>
                    </div>
                  </div>

                  <div class="flex gap-2 pt-3 border-t border-gray-200">
                    <button
                      (click)="viewDetails(request)"
                      class="flex-1 flex items-center justify-center gap-2 px-3 py-2 bg-sky-50 text-sky-600 rounded-lg hover:bg-sky-100 transition-colors"
                    >
                      <lucide-icon [img]="EyeIcon" [size]="16"></lucide-icon>
                      <span class="text-sm font-medium">{{ 'patientRequests.view' | transloco }}</span>
                    </button>
                    @if (request.status === 'pending') {
                      <button
                        (click)="approveRequest(request)"
                        class="flex items-center justify-center gap-1 px-3 py-2 bg-green-50 text-green-600 rounded-lg hover:bg-green-100 transition-colors"
                      >
                        <lucide-icon [img]="CheckIcon" [size]="16"></lucide-icon>
                      </button>
                      <button
                        (click)="rejectRequest(request)"
                        class="flex items-center justify-center gap-1 px-3 py-2 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition-colors"
                      >
                        <lucide-icon [img]="XIcon" [size]="16"></lucide-icon>
                      </button>
                    }
                  </div>
                </div>
              </div>
            }
          </div>
        }
      </div>
    </div>
  </div>
</div>

@if (selectedRequest()) {
  <div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" (click)="closeDetails()">
    <div class="bg-white rounded-xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto" (click)="$event.stopPropagation()">
      <div class="sticky top-0 bg-white border-b p-4 flex items-center justify-between">
        <h2 class="text-xl font-semibold text-gray-900">
          {{ 'patientRequests.request_details' | transloco }}
        </h2>
        <button
          (click)="closeDetails()"
          class="text-gray-400 hover:text-gray-600 transition-colors"
        >
          <lucide-icon [img]="XIcon" [size]="24"></lucide-icon>
        </button>
      </div>

      <div class="p-6">
        <div class="mb-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-2xl font-bold text-gray-900">{{ selectedRequest()!.fullName }}</h3>
            <span
              [class]="getStatusClass(selectedRequest()!.status)"
              class="px-3 py-1 text-sm font-medium rounded-full"
            >
              {{ 'patientRequests.status.' + selectedRequest()!.status | transloco }}
            </span>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
          <div>
            <label class="text-sm font-medium text-gray-600">{{ 'patientRequests.phone' | transloco }}</label>
            <p class="text-gray-900 mt-1">{{ selectedRequest()!.phone }}</p>
          </div>
          <div>
            <label class="text-sm font-medium text-gray-600">{{ 'patientRequests.birth_date' | transloco }}</label>
            <p class="text-gray-900 mt-1">{{ selectedRequest()!.birthDate }}</p>
          </div>
          @if (selectedRequest()!.address) {
            <div class="md:col-span-2">
              <label class="text-sm font-medium text-gray-600">{{ 'patientRequests.address' | transloco }}</label>
              <p class="text-gray-900 mt-1">{{ getAddress(selectedRequest()!.address) }}</p>
            </div>
          }
          @if (selectedRequest()!.emergencyContact) {
            <div class="md:col-span-2">
              <label class="text-sm font-medium text-gray-600">{{ 'patientRequests.emergency_contact' | transloco }}</label>
              <p class="text-gray-900 mt-1">
                {{ selectedRequest()!.emergencyContact.name }} ({{ selectedRequest()!.emergencyContact.relation }}) - {{ selectedRequest()!.emergencyContact.phone }}
              </p>
            </div>
          }
          @if (selectedRequest()!.allergies) {
            <div class="md:col-span-2">
              <label class="text-sm font-medium text-gray-600">{{ 'patientRequests.allergies' | transloco }}</label>
              <p class="text-gray-900 mt-1">{{ selectedRequest()!.allergies }}</p>
            </div>
          }
          @if (selectedRequest()!.medicalHistory) {
            <div class="md:col-span-2">
              <label class="text-sm font-medium text-gray-600">{{ 'patientRequests.medical_history' | transloco }}</label>
              <p class="text-gray-900 mt-1">{{ selectedRequest()!.medicalHistory }}</p>
            </div>
          }
          @if (selectedRequest()!.phoneInsurance) {
            <div>
              <label class="text-sm font-medium text-gray-600">{{ 'patientRequests.phone_insurance' | transloco }}</label>
              <p class="text-gray-900 mt-1">{{ selectedRequest()!.phoneInsurance }}</p>
            </div>
          }
          @if (selectedRequest()!.telegramUserId) {
            <div>
              <label class="text-sm font-medium text-gray-600">{{ 'patientRequests.telegram_id' | transloco }}</label>
              <p class="text-gray-900 mt-1">{{ selectedRequest()!.telegramUserId }}</p>
            </div>
          }
        </div>

        @if (selectedRequest()!.reviewNotes) {
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
            <label class="text-sm font-medium text-blue-900">{{ 'patientRequests.review_notes' | transloco }}</label>
            <p class="text-blue-800 mt-1">{{ selectedRequest()!.reviewNotes }}</p>
          </div>
        }

        <div class="bg-gray-50 rounded-lg p-4 mb-6">
          <div class="grid grid-cols-2 gap-4 text-sm">
            <div>
              <span class="text-gray-600">{{ 'patientRequests.created_at' | transloco }}:</span>
              <p class="text-gray-900 font-medium">{{ formatDate(selectedRequest()!.createdAt) }}</p>
            </div>
            <div>
              <span class="text-gray-600">{{ 'patientRequests.updated_at' | transloco }}:</span>
              <p class="text-gray-900 font-medium">{{ formatDate(selectedRequest()!.updatedAt) }}</p>
            </div>
          </div>
        </div>

        @if (selectedRequest()!.status === 'pending') {
          <div class="flex gap-3">
            <button
              (click)="approveRequest(selectedRequest()!)"
              class="flex-1 flex items-center justify-center gap-2 px-4 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors"
            >
              <lucide-icon [img]="CheckIcon" [size]="20"></lucide-icon>
              <span class="font-medium">{{ 'patientRequests.approve' | transloco }}</span>
            </button>
            <button
              (click)="rejectRequest(selectedRequest()!)"
              class="flex-1 flex items-center justify-center gap-2 px-4 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors"
            >
              <lucide-icon [img]="XIcon" [size]="20"></lucide-icon>
              <span class="font-medium">{{ 'patientRequests.reject' | transloco }}</span>
            </button>
            <button
              (click)="deleteRequest(selectedRequest()!)"
              class="flex items-center justify-center gap-2 px-4 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors"
            >
              <lucide-icon [img]="Trash2Icon" [size]="20"></lucide-icon>
            </button>
          </div>
        }
      </div>
    </div>
  </div>
}
