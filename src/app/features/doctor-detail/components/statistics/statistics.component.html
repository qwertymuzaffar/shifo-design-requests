<div class="space-y-4 sm:space-y-6">
  <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6">
    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-4">
      <div class="flex items-center space-x-2">
        <lucide-icon [img]="Calendar" class="w-5 h-5 text-sky-600"></lucide-icon>
        <h3 class="text-lg font-semibold text-gray-800">Period</h3>
      </div>
      <div class="flex flex-wrap gap-2 w-full sm:w-auto">
        <button
          (click)="selectPeriod('today')"
          [class.bg-sky-500]="selectedPeriod() === 'today'"
          [class.text-white]="selectedPeriod() === 'today'"
          [class.bg-gray-100]="selectedPeriod() !== 'today'"
          [class.text-gray-700]="selectedPeriod() !== 'today'"
          class="px-3 py-2 rounded-lg text-sm font-medium transition-colors hover:bg-sky-600 hover:text-white"
        >
          Today
        </button>
        <button
          (click)="selectPeriod('week')"
          [class.bg-sky-500]="selectedPeriod() === 'week'"
          [class.text-white]="selectedPeriod() === 'week'"
          [class.bg-gray-100]="selectedPeriod() !== 'week'"
          [class.text-gray-700]="selectedPeriod() !== 'week'"
          class="px-3 py-2 rounded-lg text-sm font-medium transition-colors hover:bg-sky-600 hover:text-white"
        >
          Week
        </button>
        <button
          (click)="selectPeriod('month')"
          [class.bg-sky-500]="selectedPeriod() === 'month'"
          [class.text-white]="selectedPeriod() === 'month'"
          [class.bg-gray-100]="selectedPeriod() !== 'month'"
          [class.text-gray-700]="selectedPeriod() !== 'month'"
          class="px-3 py-2 rounded-lg text-sm font-medium transition-colors hover:bg-sky-600 hover:text-white"
        >
          Month
        </button>
        <button
          (click)="selectPeriod('year')"
          [class.bg-sky-500]="selectedPeriod() === 'year'"
          [class.text-white]="selectedPeriod() === 'year'"
          [class.bg-gray-100]="selectedPeriod() !== 'year'"
          [class.text-gray-700]="selectedPeriod() !== 'year'"
          class="px-3 py-2 rounded-lg text-sm font-medium transition-colors hover:bg-sky-600 hover:text-white"
        >
          Year
        </button>
        <button
          (click)="selectPeriod('custom')"
          [class.bg-sky-500]="selectedPeriod() === 'custom'"
          [class.text-white]="selectedPeriod() === 'custom'"
          [class.bg-gray-100]="selectedPeriod() !== 'custom'"
          [class.text-gray-700]="selectedPeriod() !== 'custom'"
          class="px-3 py-2 rounded-lg text-sm font-medium transition-colors hover:bg-sky-600 hover:text-white"
        >
          Custom
        </button>
      </div>
    </div>

    @if (selectedDates().from && selectedDates().to) {
      <div class="flex items-center space-x-2 text-sm text-gray-600 mb-4">
        <lucide-icon [img]="Calendar" class="w-4 h-4"></lucide-icon>
        <span>{{ getFormattedDateRange() }}</span>
      </div>
    }

    @if (showCalendar()) {
      <div class="mt-4 border-t pt-4">
        <app-date-range-picker
          [selectedDates]="selectedDates()"
          (datesChange)="onDatesChange($event)"
        />
      </div>
    }
  </div>

  @if (isLoading()) {
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
      @for (item of [1, 2, 3, 4]; track item) {
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 animate-pulse">
          <div class="h-4 bg-gray-200 rounded w-3/4 mb-4"></div>
          <div class="h-8 bg-gray-200 rounded w-1/2"></div>
        </div>
      }
    </div>
  } @else {
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
      <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs sm:text-sm font-medium text-gray-600">Total Appointments</p>
            <p class="text-xl sm:text-2xl font-bold text-gray-800">{{ totalAppointments() }}</p>
          </div>
          <lucide-icon [img]="Calendar" class="w-6 h-6 sm:w-8 sm:h-8 text-blue-600"></lucide-icon>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs sm:text-sm font-medium text-gray-600">Completed</p>
            <p class="text-xl sm:text-2xl font-bold text-green-600">{{ completedAppointments() }}</p>
          </div>
          <lucide-icon [img]="Users" class="w-6 h-6 sm:w-8 sm:h-8 text-green-600"></lucide-icon>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs sm:text-sm font-medium text-gray-600">Total Revenue</p>
            <p class="text-xl sm:text-2xl font-bold text-gray-800">{{ totalRevenue() | number: '1.0-0' }} ₸</p>
          </div>
          <lucide-icon [img]="DollarSign" class="w-6 h-6 sm:w-8 sm:h-8 text-yellow-600"></lucide-icon>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs sm:text-sm font-medium text-gray-600">Completion Rate</p>
            <p class="text-xl sm:text-2xl font-bold text-gray-800">
              {{ totalAppointments() > 0 ? ((completedAppointments() / totalAppointments()) * 100).toFixed(1) : 0 }}%
            </p>
          </div>
          <lucide-icon [img]="TrendingUp" class="w-6 h-6 sm:w-8 sm:h-8 text-blue-600"></lucide-icon>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-xl shadow-lg p-4 sm:p-6">
      <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-3 sm:mb-4 flex items-center space-x-2">
        <lucide-icon [img]="TrendingUp" class="w-5 h-5 sm:w-6 sm:h-6 text-blue-600"></lucide-icon>
        <span>Performance Overview</span>
      </h3>
      <div class="space-y-4">
        <div>
          <div class="flex justify-between items-center mb-2">
            <span class="text-sm font-medium text-gray-700">Appointment Completion</span>
            <span class="text-sm font-semibold text-gray-900">
              {{ totalAppointments() > 0 ? ((completedAppointments() / totalAppointments()) * 100).toFixed(0) : 0 }}%
            </span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2">
            <div
              class="bg-emerald-600 h-2 rounded-full transition-all duration-300"
              [style.width.%]="totalAppointments() > 0 ? (completedAppointments() / totalAppointments()) * 100 : 0"
            ></div>
          </div>
        </div>

        <div class="grid grid-cols-2 sm:grid-cols-3 gap-4 pt-4 border-t border-gray-200">
          <div>
            <p class="text-xs text-gray-500 mb-1">Average per month</p>
            <p class="text-lg font-semibold text-gray-900">
              {{ totalAppointments() > 0 ? (totalAppointments() / 12).toFixed(1) : 0 }}
            </p>
          </div>
          <div>
            <p class="text-xs text-gray-500 mb-1">Avg. revenue/appointment</p>
            <p class="text-lg font-semibold text-gray-900">
              {{ completedAppointments() > 0 ? (totalRevenue() / completedAppointments()).toFixed(0) : 0 }} ₸
            </p>
          </div>
          <div class="col-span-2 sm:col-span-1">
            <p class="text-xs text-gray-500 mb-1">Active status</p>
            <p class="text-lg font-semibold text-emerald-600">Active</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Patient Analytics -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 sm:p-6">
      <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center space-x-2">
        <lucide-icon [img]="Users" class="w-5 h-5 text-blue-600"></lucide-icon>
        <span>Patient Analytics</span>
      </h3>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
        <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-4 border border-blue-200">
          <p class="text-sm font-medium text-blue-700 mb-1">Unique Patients</p>
          <p class="text-3xl font-bold text-blue-900">{{ uniquePatients() }}</p>
        </div>
        <div class="bg-gradient-to-br from-emerald-50 to-emerald-100 rounded-lg p-4 border border-emerald-200">
          <p class="text-sm font-medium text-emerald-700 mb-1">New Patients</p>
          <p class="text-3xl font-bold text-emerald-900">{{ newPatients() }}</p>
          <p class="text-xs text-emerald-600 mt-1">First visit</p>
        </div>
        <div class="bg-gradient-to-br from-cyan-50 to-cyan-100 rounded-lg p-4 border border-cyan-200">
          <p class="text-sm font-medium text-cyan-700 mb-1">Returning Patients</p>
          <p class="text-3xl font-bold text-cyan-900">{{ returningPatients() }}</p>
          <p class="text-xs text-cyan-600 mt-1">Repeat visits</p>
        </div>
      </div>
      @if (uniquePatients() > 0) {
        <div class="mt-4 pt-4 border-t border-gray-200">
          <div class="flex justify-between items-center mb-2">
            <span class="text-sm font-medium text-gray-700">Patient Retention Rate</span>
            <span class="text-sm font-semibold text-blue-600">
              {{ ((returningPatients() / uniquePatients()) * 100).toFixed(1) }}%
            </span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2.5">
            <div
              class="bg-gradient-to-r from-blue-500 to-blue-600 h-2.5 rounded-full transition-all duration-300"
              [style.width.%]="(returningPatients() / uniquePatients()) * 100"
            ></div>
          </div>
        </div>
      }
    </div>

    <!-- Cancellation Analytics -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 sm:p-6">
      <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center space-x-2">
        <lucide-icon [img]="Calendar" class="w-5 h-5 text-red-600"></lucide-icon>
        <span>Cancellation Analytics</span>
      </h3>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
        <div class="bg-gradient-to-br from-amber-50 to-amber-100 rounded-lg p-4 border border-amber-200">
          <p class="text-sm font-medium text-amber-700 mb-1">Cancelled</p>
          <p class="text-3xl font-bold text-amber-900">{{ cancelledAppointments() }}</p>
          <p class="text-xs text-amber-600 mt-1">
            {{ totalAppointments() > 0 ? ((cancelledAppointments() / totalAppointments()) * 100).toFixed(1) : 0 }}% of total
          </p>
        </div>
        <div class="bg-gradient-to-br from-red-50 to-red-100 rounded-lg p-4 border border-red-200">
          <p class="text-sm font-medium text-red-700 mb-1">No-Show</p>
          <p class="text-3xl font-bold text-red-900">{{ noShowAppointments() }}</p>
          <p class="text-xs text-red-600 mt-1">
            {{ totalAppointments() > 0 ? ((noShowAppointments() / totalAppointments()) * 100).toFixed(1) : 0 }}% of total
          </p>
        </div>
        <div class="bg-gradient-to-br from-emerald-50 to-emerald-100 rounded-lg p-4 border border-emerald-200">
          <p class="text-sm font-medium text-emerald-700 mb-1">Success Rate</p>
          <p class="text-3xl font-bold text-emerald-900">
            {{ totalAppointments() > 0 ? ((completedAppointments() / totalAppointments()) * 100).toFixed(1) : 0 }}%
          </p>
          <p class="text-xs text-emerald-600 mt-1">Completed appointments</p>
        </div>
      </div>
    </div>

    <!-- Appointment Types Distribution -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 sm:p-6">
      <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center space-x-2">
        <lucide-icon [img]="Calendar" class="w-5 h-5 text-blue-600"></lucide-icon>
        <span>Appointment Types</span>
      </h3>
      <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
        <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-4 text-center border border-blue-200">
          <div class="text-3xl font-bold text-blue-900 mb-1">{{ consultationCount() }}</div>
          <div class="text-sm font-medium text-blue-700">Consultation</div>
        </div>
        <div class="bg-gradient-to-br from-teal-50 to-teal-100 rounded-lg p-4 text-center border border-teal-200">
          <div class="text-3xl font-bold text-teal-900 mb-1">{{ followUpCount() }}</div>
          <div class="text-sm font-medium text-teal-700">Follow-up</div>
        </div>
        <div class="bg-gradient-to-br from-amber-50 to-amber-100 rounded-lg p-4 text-center border border-amber-200">
          <div class="text-3xl font-bold text-amber-900 mb-1">{{ procedureCount() }}</div>
          <div class="text-sm font-medium text-amber-700">Procedure</div>
        </div>
        <div class="bg-gradient-to-br from-rose-50 to-rose-100 rounded-lg p-4 text-center border border-rose-200">
          <div class="text-3xl font-bold text-rose-900 mb-1">{{ emergencyCount() }}</div>
          <div class="text-sm font-medium text-rose-700">Emergency</div>
        </div>
      </div>
    </div>

    <!-- Temporal Statistics -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 sm:p-6">
      <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center space-x-2">
        <lucide-icon [img]="Calendar" class="w-5 h-5 text-blue-600"></lucide-icon>
        <span>Time Analytics</span>
      </h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <h4 class="text-sm font-semibold text-gray-700 mb-3">Busiest Day</h4>
          <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-5 border border-blue-200">
            <div class="text-2xl font-bold text-blue-900">{{ busiestDay() }}</div>
            <p class="text-xs text-blue-600 mt-1">Most appointments on this day</p>
          </div>
        </div>
        <div>
          <h4 class="text-sm font-semibold text-gray-700 mb-3">Peak Hours</h4>
          <div class="space-y-2">
            @for (hour of peakHours().slice(0, 3); track hour.hour) {
              <div class="flex items-center justify-between bg-gradient-to-r from-gray-50 to-blue-50 rounded-lg p-3 border border-gray-200">
                <span class="text-sm font-medium text-gray-700">{{ hour.hour }}:00 - {{ hour.hour + 1 }}:00</span>
                <span class="text-sm font-bold text-blue-600">{{ hour.count }} appts</span>
              </div>
            }
            @if (peakHours().length === 0) {
              <p class="text-sm text-gray-500 italic">No data available</p>
            }
          </div>
        </div>
      </div>
    </div>

    <!-- Daily Timeline Chart -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 sm:p-6">
      <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center space-x-2">
        <lucide-icon [img]="TrendingUp" class="w-5 h-5 text-blue-600"></lucide-icon>
        <span>Appointments Timeline</span>
      </h3>
      @if (dailyStats().length > 0) {
        <div class="space-y-3">
          @for (day of getDisplayedTimeline(); track day.date) {
            <div class="border-b border-gray-100 pb-3 last:border-0">
              <div class="flex justify-between items-center mb-2">
                <span class="text-sm font-medium text-gray-700">
                  {{ formatDailyDate(day.date) }}
                </span>
                <div class="flex items-center space-x-4">
                  <span class="text-xs text-gray-600">{{ day.appointments }} appts</span>
                  <span class="text-sm font-semibold text-blue-600">{{ day.revenue | number: '1.0-0' }} ₸</span>
                </div>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2.5">
                <div
                  class="bg-gradient-to-r from-blue-500 to-blue-600 h-2.5 rounded-full transition-all duration-300"
                  [style.width.%]="(day.appointments / totalAppointments()) * 100"
                ></div>
              </div>
            </div>
          }
        </div>
        @if (dailyStats().length > 4) {
          <button
            (click)="toggleTimelineView()"
            class="mt-4 w-full px-4 py-2 text-sm font-medium text-blue-600 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors border border-blue-200"
          >
            {{ showAllTimeline() ? 'See less' : 'See more' }}
          </button>
        }
      } @else {
        <p class="text-sm text-gray-500 text-center py-8">No data available for the selected period</p>
      }
    </div>

    <!-- Financial Metrics -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 sm:p-6">
      <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center space-x-2">
        <lucide-icon [img]="DollarSign" class="w-5 h-5 text-emerald-600"></lucide-icon>
        <span>Financial Breakdown</span>
      </h3>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
        <div class="bg-gradient-to-br from-emerald-50 to-emerald-100 rounded-lg p-4 border border-emerald-200">
          <p class="text-sm font-medium text-emerald-700 mb-1">Total Revenue</p>
          <p class="text-2xl font-bold text-emerald-900">{{ totalRevenue() | number: '1.0-0' }} ₸</p>
        </div>
        <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-4 border border-blue-200">
          <p class="text-sm font-medium text-blue-700 mb-1">Average Payment</p>
          <p class="text-2xl font-bold text-blue-900">{{ averagePayment() | number: '1.0-0' }} ₸</p>
        </div>
        <div class="bg-gradient-to-br from-amber-50 to-amber-100 rounded-lg p-4 border border-amber-200">
          <p class="text-sm font-medium text-amber-700 mb-1">Unpaid</p>
          <p class="text-2xl font-bold text-amber-900">{{ unpaidAppointments() }}</p>
          <p class="text-xs text-amber-600 mt-1">Pending payments</p>
        </div>
      </div>
      @if (paymentMethods().length > 0) {
        <div class="border-t border-gray-200 pt-4">
          <h4 class="text-sm font-semibold text-gray-700 mb-3">Payment Methods Distribution</h4>
          <div class="space-y-2">
            @for (method of paymentMethods(); track method.method) {
              <div class="flex items-center justify-between bg-gradient-to-r from-gray-50 to-blue-50 rounded-lg p-3 border border-gray-200 hover:border-blue-300 transition-colors">
                <div class="flex items-center space-x-3">
                  <div class="w-2.5 h-2.5 rounded-full bg-gradient-to-r from-blue-500 to-emerald-500"></div>
                  <span class="text-sm font-medium text-gray-700 capitalize">{{ method.method }}</span>
                </div>
                <div class="text-right">
                  <div class="text-sm font-bold text-gray-900">{{ method.amount | number: '1.0-0' }} ₸</div>
                  <div class="text-xs text-gray-500">{{ method.count }} transactions</div>
                </div>
              </div>
            }
          </div>
        </div>
      } @else {
        <div class="border-t border-gray-200 pt-4">
          <p class="text-sm text-gray-500 text-center py-4">No payment data available</p>
        </div>
      }
    </div>

    <!-- Additional Analytics -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 sm:p-6">
      <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center space-x-2">
        <lucide-icon [img]="TrendingUp" class="w-5 h-5 text-blue-600"></lucide-icon>
        <span>Performance Metrics</span>
      </h3>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
        <div>
          <h4 class="text-sm font-semibold text-gray-700 mb-3">Average Session Duration</h4>
          <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-5 border border-blue-200">
            <div class="flex items-baseline space-x-2">
              <div class="text-3xl font-bold text-blue-900">{{ averageDuration() | number: '1.0-0' }}</div>
              <span class="text-sm text-blue-700">min</span>
            </div>
            <p class="text-sm text-blue-600 mt-1">per appointment</p>
          </div>
        </div>
        <div>
          <h4 class="text-sm font-semibold text-gray-700 mb-3">Utilization Rate</h4>
          <div class="bg-gradient-to-br from-emerald-50 to-emerald-100 rounded-lg p-5 border border-emerald-200">
            <div class="flex items-baseline space-x-2">
              <div class="text-3xl font-bold text-emerald-900">{{ utilizationRate() | number: '1.0-1' }}</div>
              <span class="text-sm text-emerald-700">%</span>
            </div>
            <p class="text-sm text-emerald-600 mt-1">of available time</p>
          </div>
          <div class="mt-3">
            <div class="w-full bg-gray-200 rounded-full h-2.5">
              <div
                class="bg-gradient-to-r from-emerald-500 to-emerald-600 h-2.5 rounded-full transition-all duration-300"
                [style.width.%]="utilizationRate()"
              ></div>
            </div>
          </div>
        </div>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mt-6 pt-6 border-t border-gray-200">
        <div class="text-center p-4 bg-gray-50 rounded-lg border border-gray-200">
          <p class="text-xs text-gray-600 mb-1">Avg per Day</p>
          <p class="text-2xl font-bold text-gray-900">
            {{ totalAppointments() > 0 ? (totalAppointments() / 30).toFixed(1) : 0 }}
          </p>
        </div>
        <div class="text-center p-4 bg-gray-50 rounded-lg border border-gray-200">
          <p class="text-xs text-gray-600 mb-1">Avg per Week</p>
          <p class="text-2xl font-bold text-gray-900">
            {{ totalAppointments() > 0 ? (totalAppointments() / 4).toFixed(1) : 0 }}
          </p>
        </div>
        <div class="text-center p-4 bg-gray-50 rounded-lg border border-gray-200">
          <p class="text-xs text-gray-600 mb-1">Total Hours</p>
          <p class="text-2xl font-bold text-gray-900">
            {{ ((averageDuration() * totalAppointments()) / 60) | number: '1.0-0' }}
          </p>
        </div>
      </div>
    </div>
  }
</div>
