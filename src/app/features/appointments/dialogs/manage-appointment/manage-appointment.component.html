<form [formGroup]="appointmentForm" (ngSubmit)="onSubmit()" class="space-y-6">
  <div class="flex items-center justify-between mb-6">
    <h3 class="text-xl font-semibold text-gray-900">
      {{ isEditing ? ('appointment-form.edit_title' | transloco) : ('appointment-form.create_title' | transloco) }}
    </h3>
    <button
      matDialogClose
      class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors"
    >
      <lucide-icon [name]="X" [size]="20"></lucide-icon>
    </button>
  </div>

  @if (payment.value(); as paymentItem) {
    <div
      class="flex items-center gap-2 bg-green-100 border border-green-300 rounded px-4 py-2 my-2"
    >
      <span class="text-green-600 text-xl">&#10003;</span>
      <span class="font-semibold text-green-700">{{ 'appointment-form.paid' | transloco }}</span>
      <span class="text-green-500 text-sm">
        ({{ paymentItem.paidAt | date: 'short' }})
      </span>
      <span class="ml-auto font-medium text-green-800">
        {{ paymentItem.amount }}—Å. ({{ getCurrency(paymentItem.paymentType) }})
      </span>
    </div>
  }

  <div class="grid grid-cols-2 gap-2">
    <app-form-field label="{{ 'appointment-form.type' | transloco }}" [control]="appointmentForm.controls['type']">
      <select
        formControlName="type"
        class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-colors"
      >
        <option value="consultation">{{ 'appointment-form.consultation' | transloco }}</option>
        <option value="followup">{{ 'appointment-form.followup' | transloco }}</option>
        <option value="procedure">{{ 'appointment-form.procedure' | transloco }}</option>
        <option value="emergency">{{ 'appointment-form.emergency' | transloco }}</option>
      </select>
    </app-form-field>

    @if (appointmentForm.get('type')?.value === 'procedure') {
      <div class="procedure w-[372px]">
        <app-form-field
          label="{{ 'appointment-form.procedure_label' | transloco }}"
          [control]="appointmentForm.controls['procedure']"
        >
          <select
            formControlName="procedure"
            class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-colors"
          >
            <option value="" disabled selected>{{ 'appointment-form.choose_procedure' | transloco }}</option>
            @for (p of procedure(); track $index) {
               <option [value]="p.id">{{ p.name }}</option>
            }
          </select>
        </app-form-field>
      </div>
    }

    <app-form-field label="{{ 'appointment-form.patient' | transloco }}" [control]="patientControl">
      <input [formControl]="patientControl" [matAutocomplete]="auto" />
      <mat-autocomplete
        #auto="matAutocomplete"
        optionsScroll
        (optionsScroll)="loadPatients()"
      >
        @if (loadingPatients()) {
          <mat-option disabled>{{ 'appointment-form.loading' | transloco }}</mat-option>
        }

        @for (patient of patientPagination().items; track patient.id) {
          <mat-option
            (click)="selectPatient(patient)"
            [value]="patient.fullName"
          >
            {{ patient.fullName }}
          </mat-option>
        }
      </mat-autocomplete>
    </app-form-field>

    <app-form-field label="{{ 'appointment-form.doctor' | transloco }}" [control]="doctorControl">
      <input
        type="text"
        [formControl]="doctorControl"
        [matAutocomplete]="doc"
      />
      <mat-autocomplete
        #doc="matAutocomplete"
        optionsScroll
        (optionsScroll)="loadDoctors()"
      >
        @if (loadingDoctors()) {
          <mat-option disabled>{{ 'appointment-form.loading' | transloco }}</mat-option>
        }

        @for (doctor of doctorPagination().items; track doctor.id) {
          <mat-option
            (click)="selectDoctor(doctor)"
            [value]="doctor.firstName + ' ' + doctor.lastName"
          >
            {{ doctor.firstName }} {{ doctor.lastName }}
          </mat-option>
        }
      </mat-autocomplete>
    </app-form-field>

    <app-form-field label="{{ 'appointment-form.duration' | transloco }}" [control]="appointmentForm.controls['duration']">
      <select
        type="number"
        formControlName="duration"
        class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-colors"
      >
        <option [value]="15">{{ 'appointment-form.15min' | transloco }}</option>
        <option [value]="20">{{ 'appointment-form.20min' | transloco }}</option>
        <option [value]="30">{{ 'appointment-form.30min' | transloco }}</option>
        <option [value]="45">{{ 'appointment-form.45min' | transloco }}</option>
        <option [value]="60">{{ 'appointment-form.1h' | transloco }}</option>
        <option [value]="90">{{ 'appointment-form.1h30min' | transloco }}</option>
        <option [value]="120">{{ 'appointment-form.2h' | transloco }}</option>
      </select>
    </app-form-field>

    <ng-container formArrayName="datetimes">
      @for (dateTime of dateTimes.controls; track dateTime; let index = $index) {
        <div [formGroupName]="index" class="col-span-2 flex items-center gap-x-2">
          <app-form-field class="flex-1" label="{{ 'appointment-form.date' | transloco }}" [control]="getControl(index, 'date')">
            <input
              type="date"
              formControlName="date"
              class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-colors"
              required
            />
          </app-form-field>

          <div class="flex-1 flex items-center gap-2">
            <app-form-field class="flex-1" label="{{ 'appointment-form.time' | transloco }}" [control]="getControl(index, 'time')">
              <input
                class="time"
                type="time"
                lang="ru"
                min="08:00"
                max="18:00"
                formControlName="time"
                required
              />
            </app-form-field>

            @if (!isEditing) {
              @if (index !== 0) {
                <button
                  (click)="removeDateTime(index)"
                  type="button"
                  class="mt-5 flex items-center justify-center w-10 h-10 rounded-full bg-red-500 text-white shadow-md hover:bg-red-600 active:scale-95 transition-all duration-200 ease-in-out"
                >
                  <lucide-icon [img]="X" class="w-5 h-5"></lucide-icon>
                </button>
              } @else {
                <button
                  (click)="addDateTime()"
                  type="button"
                  class="mt-5 flex items-center justify-center w-10 h-10 rounded-full bg-sky-500 text-white shadow-md hover:bg-sky-600 active:scale-95 transition-all duration-200 ease-in-out"
                >
                  <lucide-icon [img]="Plus" class="w-5 h-5"></lucide-icon>
                </button>
              }
            }
          </div>
        </div>
      }
    </ng-container>

    @if (isEditing) {
      <app-form-field label="{{ 'appointment-form.status' | transloco }}" [control]="appointmentForm.controls['status']">
        <select
          formControlName="status"
          class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-colors"
        >
          <option [value]="appointmentStatus.SCHEDULED">{{ 'appointment-form.status_scheduled' | transloco }}</option>
          <option [value]="appointmentStatus.COMPLETED">{{ 'appointment-form.status_completed' | transloco }}</option>
          <option [value]="appointmentStatus.CANCELLED">{{ 'appointment-form.status_cancelled' | transloco }}</option>
          <option [value]="appointmentStatus.TEMPORARY">{{ 'appointment-form.temporary' | transloco }}</option>
          <option [value]="appointmentStatus.CANCELLED_FOREVER">{{ 'appointment-form.cancelled_forever' | transloco }}</option>
        </select>
      </app-form-field>

      <app-form-field label="{{ 'appointment-form.payment_type' | transloco }}" [control]="appointmentForm.controls['paymentType']">
        <select formControlName="paymentType">
          <option selected [value]="paymentType.CASH">{{ 'appointment-form.cash' | transloco }}</option>
          <option [value]="paymentType.DC">{{ 'appointment-form.dc' | transloco }}</option>
          <option [value]="paymentType.ESKHATA">{{ 'appointment-form.eskhata' | transloco }}</option>
          <option [value]="paymentType.ALIF">{{ 'appointment-form.alif' | transloco }}</option>
        </select>
      </app-form-field>
    }
  </div>

  <div class="bg-green-50 p-4 rounded-lg border border-green-200">
    <label class="block text-sm font-medium text-green-800 mb-2">
      {{ 'appointment-form.recommended_time' | transloco }}
    </label>
    <div class="flex flex-wrap gap-2">
      @for (slot of suggestedSlots; track slot) {
        <button
          type="button"
          (click)="handleTimeChange(slot)"
          class="px-3 py-1 bg-green-100 text-green-800 rounded-lg text-sm hover:bg-green-200 transition-colors border border-green-300"
        >
          {{ slot }}
        </button>
      }
    </div>
  </div>

  <div class="space-y-4">
    <app-form-field label="{{ 'appointment-form.symptoms' | transloco }}" [control]="appointmentForm.controls['symptoms']">
      <textarea
        formControlName="symptoms"
        rows="3"
        class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-colors"
        placeholder="{{ 'appointment-form.symptoms_placeholder' | transloco }}"
      ></textarea>
    </app-form-field>

    <app-form-field label="{{ 'appointment-form.notes' | transloco }}" [control]="appointmentForm.controls['notes']">
      <textarea
        formControlName="notes"
        rows="2"
        placeholder="{{ 'appointment-form.notes_placeholder' | transloco }}"
      ></textarea>
    </app-form-field>
  </div>

  <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
    <button
      matDialogClose
      type="button"
      class="px-6 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors"
    >
      {{ 'appointment-form.cancel' | transloco }}
    </button>
    <button
      [disabled]="isSubmitting()"
      type="submit"
      class="px-6 py-2 bg-sky-500 text-white rounded-lg hover:bg-sky-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
    >
      {{ isEditing ? ('appointment-form.save_changes' | transloco) : ('appointment-form.create' | transloco) }}
      {{ isSubmitting() ? '...' : '' }}
    </button>
  </div>
</form>
